#!/home/alexballera/mcp-servers/.venv/bin/python3
"""
ðŸš€ GROQ TERMINAL AGENT - Cliente de terminal ultra-rÃ¡pido
Agente AI para la terminal usando Groq (0.5-2 segundos)
"""

import os
import sys
import requests
import json
import time
import argparse
from dotenv import load_dotenv

# Cargar variables de entorno
load_dotenv()

class GroqTerminalAgent:
    def __init__(self):
        self.api_key = os.getenv('GROQ_API_KEY')
        self.base_url = "https://api.groq.com/openai/v1/chat/completions"
        self.model = "llama-3.1-8b-instant"  # Modelo mÃ¡s rÃ¡pido
        
        if not self.api_key:
            print("âŒ Error: GROQ_API_KEY no encontrada en .env")
            print("ðŸ“ Configura: echo 'GROQ_API_KEY=tu_key' >> .env")
            sys.exit(1)

    def chat(self, message: str, system: str = "", max_tokens: int = 1000) -> str:
        """Chat con Groq"""
        try:
            start_time = time.time()
            
            messages = []
            if system:
                messages.append({"role": "system", "content": system})
            messages.append({"role": "user", "content": message})
            
            data = {
                "model": self.model,
                "messages": messages,
                "max_tokens": max_tokens,
                "temperature": 0.7,
                "stream": False
            }
            
            response = requests.post(
                self.base_url,
                headers={
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                },
                json=data,
                timeout=10
            )
            
            end_time = time.time()
            duration = end_time - start_time
            
            if response.status_code == 200:
                result = response.json()
                content = result["choices"][0]["message"]["content"]
                
                # Mostrar info de velocidad
                speed_emoji = "âš¡" if duration < 2 else "ðŸ”¥" if duration < 5 else "â±ï¸"
                print(f"\n{speed_emoji} Respuesta en {duration:.2f}s")
                return content
            else:
                return f"âŒ Error: {response.status_code} - {response.text}"
                
        except Exception as e:
            return f"âŒ Error: {str(e)}"

    def code_help(self, query: str) -> str:
        """Ayuda especializada en cÃ³digo"""
        system = """Eres un experto programador. Responde de forma concisa y prÃ¡ctica.
        Si es cÃ³digo, muestra ejemplos funcionales. Si es un error, da la soluciÃ³n directa."""
        return self.chat(query, system, max_tokens=800)

    def quick_fix(self, problem: str) -> str:
        """SoluciÃ³n rÃ¡pida a problemas"""
        system = """Da una soluciÃ³n directa y prÃ¡ctica. MÃ¡ximo 3 pÃ¡rrafos.
        EnfÃ³cate en la soluciÃ³n, no en explicaciones largas."""
        return self.chat(problem, system, max_tokens=500)

    def explain(self, concept: str) -> str:
        """Explicar conceptos"""
        system = """Explica de forma clara y concisa. Usa ejemplos prÃ¡cticos.
        Estructura: definiciÃ³n breve â†’ ejemplo â†’ uso prÃ¡ctico."""
        return self.chat(f"Explica: {concept}", system, max_tokens=600)

def main():
    parser = argparse.ArgumentParser(
        description='ðŸš€ Groq Terminal Agent - Asistente AI ultra-rÃ¡pido',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Ejemplos de uso:
  groq "Â¿CÃ³mo hacer un bucle en Python?"
  groq --code "Error: ModuleNotFoundError: No module named 'requests'"
  groq --fix "Mi cÃ³digo Python no funciona"
  groq --explain "list comprehension en Python"
  groq --chat                    # Modo interactivo
        """
    )
    
    parser.add_argument('message', nargs='?', help='Mensaje para el agente')
    parser.add_argument('--code', '-c', metavar='QUERY', help='Ayuda de cÃ³digo')
    parser.add_argument('--fix', '-f', metavar='PROBLEM', help='SoluciÃ³n rÃ¡pida')
    parser.add_argument('--explain', '-e', metavar='CONCEPT', help='Explicar concepto')
    parser.add_argument('--chat', '-i', action='store_true', help='Modo interactivo')
    
    args = parser.parse_args()
    
    agent = GroqTerminalAgent()
    
    # Banner
    print("ðŸš€ GROQ TERMINAL AGENT")
    print("=" * 40)
    
    try:
        if args.chat:
            # Modo interactivo
            print("ðŸ’¬ Modo chat interactivo (Ctrl+C para salir)")
            print("Escribe tus preguntas:")
            print()
            
            while True:
                try:
                    user_input = input("ðŸ¤– Tu: ").strip()
                    if not user_input:
                        continue
                        
                    if user_input.lower() in ['exit', 'quit', 'salir']:
                        print("ðŸ‘‹ Â¡Hasta luego!")
                        break
                        
                    response = agent.chat(user_input)
                    print(f"\nðŸ’¡ Groq: {response}\n")
                    
                except KeyboardInterrupt:
                    print("\nðŸ‘‹ Â¡Hasta luego!")
                    break
                    
        elif args.code:
            response = agent.code_help(args.code)
            print(f"\nðŸ’» Ayuda de cÃ³digo:\n{response}")
            
        elif args.fix:
            response = agent.quick_fix(args.fix)
            print(f"\nðŸ”§ SoluciÃ³n:\n{response}")
            
        elif args.explain:
            response = agent.explain(args.explain)
            print(f"\nðŸ“š ExplicaciÃ³n:\n{response}")
            
        elif args.message:
            response = agent.chat(args.message)
            print(f"\nðŸ’¡ Respuesta:\n{response}")
            
        else:
            parser.print_help()
            
    except KeyboardInterrupt:
        print("\nðŸ‘‹ Â¡Hasta luego!")
        sys.exit(0)

if __name__ == "__main__":
    main()
